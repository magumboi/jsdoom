<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JS DOOM ðŸ•¹</title>
    <link rel="stylesheet" type="text/css" href="./style.css">
    <link rel="stylesheet" type="text/css" href="./styles/button.css">
    <style>
        /* Mobile Touch Controls */
        .mobile-controls {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .mobile-controls.active {
            display: block;
        }

        /* Virtual Joystick - Left Side */
        .virtual-joystick {
            position: absolute;
            bottom: 40px;
            left: 40px;
            width: 120px;
            height: 120px;
            background: rgba(255, 255, 255, 0.1);
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            pointer-events: auto;
            touch-action: none;
        }

        .joystick-knob {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid rgba(255, 255, 255, 1);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.1s ease;
            pointer-events: none;
        }

        /* Aim Area - Right Side */
        .aim-area {
            position: absolute;
            top: 0;
            right: 0;
            width: 50%;
            height: 70%;
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed rgba(255, 255, 255, 0.2);
            pointer-events: auto;
            touch-action: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.4);
            font-size: 14px;
            font-weight: bold;
        }

        .aim-area::before {
            content: "AIM AREA\nDrag to look around";
            text-align: center;
            white-space: pre-line;
        }

        /* Action Buttons */
        .action-buttons {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 200px;
            height: 120px;
            pointer-events: none;
        }

        .touch-button {
            position: absolute;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 8px;
            color: white;
            font-weight: bold;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            user-select: none;
            touch-action: manipulation;
        }

        .touch-button:active {
            background: rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 255, 255, 0.6);
            transform: scale(0.95);
        }

        .btn-fire {
            bottom: 60px;
            right: 0;
            width: 70px;
            height: 50px;
            background: rgba(255, 50, 50, 0.4);
            border-color: rgba(255, 50, 50, 0.6);
            font-size: 16px;
            font-weight: bold;
        }

        .btn-fire:active {
            background: rgba(255, 50, 50, 0.7);
        }

        .btn-action {
            bottom: 60px;
            right: 80px;
            width: 50px;
            height: 50px;
            background: rgba(50, 255, 50, 0.4);
            border-color: rgba(50, 255, 50, 0.6);
            font-size: 12px;
        }

        .btn-action:active {
            background: rgba(50, 255, 50, 0.7);
        }

        .btn-run {
            bottom: 10px;
            right: 40px;
            width: 50px;
            height: 40px;
            background: rgba(50, 50, 255, 0.4);
            border-color: rgba(50, 50, 255, 0.6);
            font-size: 12px;
        }

        .btn-run:active {
            background: rgba(50, 50, 255, 0.7);
        }

        .btn-weapon {
            bottom: 10px;
            right: 100px;
            width: 60px;
            height: 40px;
            background: rgba(255, 255, 50, 0.4);
            border-color: rgba(255, 255, 50, 0.6);
            font-size: 11px;
        }

        .btn-weapon:active {
            background: rgba(255, 255, 50, 0.7);
        }

        /* Menu Button */
        .btn-menu {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 60px;
            height: 40px;
            background: rgba(128, 128, 128, 0.4);
            border-color: rgba(128, 128, 128, 0.6);
            font-size: 12px;
            pointer-events: auto;
        }

        .btn-menu:active {
            background: rgba(128, 128, 128, 0.7);
        }

        @media (max-width: 768px) {
            .dosbox-container {
                width: 100vw;
                height: 60vh;
                margin: 5% auto 0 auto;
            }
        }

        /* Fullscreen dosbox canvas styles */
        .dosbox-canvas:fullscreen,
        .dosbox-canvas:-webkit-full-screen,
        .dosbox-canvas:-moz-full-screen,
        .dosbox-canvas:-ms-fullscreen {
            width: 100vw !important;
            height: 100vh !important;
            background: #000;
            object-fit: contain;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="dosbox"></div>
        <button class="wrapper" onclick="enterFullscreen();">
            <a><span>FULLSCREEN</span></a>
        </button>
    </div>

    <!-- Mobile Touch Controls -->
    <div class="mobile-controls" id="mobileControls">
        <!-- Virtual Joystick - Left Side -->
        <div class="virtual-joystick" id="virtualJoystick">
            <div class="joystick-knob" id="joystickKnob"></div>
        </div>

        <!-- Aim Area - Right Side -->
        <div class="aim-area" id="aimArea"></div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <div class="touch-button btn-fire" data-key="Control">FIRE</div>
            <div class="touch-button btn-action" data-key=" ">USE</div>
            <div class="touch-button btn-run" data-key="Shift">RUN</div>
            <div class="touch-button btn-weapon" data-key="Tab">WEAPON</div>
        </div>

        <!-- Menu Button -->
        <div class="touch-button btn-menu" data-key="Escape">MENU</div>
    </div>

    <script type="text/javascript" src="./script.js"></script>
    <script type="text/javascript">
        var dosbox = new Dosbox({
            id: "dosbox",
            onload: function (dosbox) {
                dosbox.run("/jsdoom/roms/ultimate-doom.zip", "./UltDoom/DOOM.EXE");
            },
            onrun: function (dosbox, app) {
                console.log("App '" + app + "' is runned");
            }
        });

        // Mobile Detection and Touch Controls
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                   (window.innerWidth <= 768 && 'ontouchstart' in window);
        }

        function isFullscreen() {
            return !!(document.fullscreenElement || document.webkitFullscreenElement || 
                     document.mozFullScreenElement || document.msFullscreenElement);
        }

        function enterFullscreen() {
            const dosboxCanvas = document.querySelector('.dosbox-canvas');
            if (!dosboxCanvas) {
                console.log('Dosbox canvas not found');
                return;
            }

            const element = dosboxCanvas;
            if (element.requestFullscreen) {
                element.requestFullscreen();
            } else if (element.webkitRequestFullscreen) {
                element.webkitRequestFullscreen();
            } else if (element.mozRequestFullScreen) {
                element.mozRequestFullScreen();
            } else if (element.msRequestFullscreen) {
                element.msRequestFullscreen();
            }
        }

        function updateMobileControls() {
            const mobileControls = document.getElementById('mobileControls');
            if (isMobileDevice() && isFullscreen()) {
                mobileControls.classList.add('active');
                console.log('Mobile fullscreen detected, showing touch controls');
            } else {
                mobileControls.classList.remove('active');
            }
        }

        function initMobileControls() {
            if (!isMobileDevice()) return;

            // Listen for fullscreen changes
            document.addEventListener('fullscreenchange', updateMobileControls);
            document.addEventListener('webkitfullscreenchange', updateMobileControls);
            document.addEventListener('mozfullscreenchange', updateMobileControls);
            document.addEventListener('MSFullscreenChange', updateMobileControls);

            // Get the canvas element for key events
            let canvas = null;
            const findCanvas = () => {
                canvas = document.querySelector('.dosbox-canvas');
                if (!canvas) {
                    setTimeout(findCanvas, 100);
                }
            };
            findCanvas();

            // Movement state
            let moveState = { forward: false, backward: false, left: false, right: false };
            let currentKeys = new Set();

            // Function to simulate key events
            function simulateKeyEvent(keyCode, type) {
                if (!canvas) return;
                
                let eventKeyCode = 0;
                switch(keyCode) {
                    case 'ArrowUp': eventKeyCode = 38; break;
                    case 'ArrowDown': eventKeyCode = 40; break;
                    case 'ArrowLeft': eventKeyCode = 37; break;
                    case 'ArrowRight': eventKeyCode = 39; break;
                    case ' ': eventKeyCode = 32; break;
                    case 'Control': eventKeyCode = 17; break;
                    case 'Shift': eventKeyCode = 16; break;
                    case 'Tab': eventKeyCode = 9; break;
                    case 'Escape': eventKeyCode = 27; break;
                }
                
                const event = new KeyboardEvent(type, {
                    key: keyCode,
                    code: keyCode,
                    keyCode: eventKeyCode,
                    ctrlKey: keyCode === 'Control',
                    shiftKey: keyCode === 'Shift',
                    bubbles: true,
                    cancelable: true
                });
                
                canvas.dispatchEvent(event);
                document.dispatchEvent(event);
            }

            function updateMovement(dx, dy) {
                const threshold = 0.3;
                const newMoveState = {
                    forward: dy < -threshold,
                    backward: dy > threshold,
                    left: dx < -threshold,
                    right: dx > threshold
                };

                // Handle forward/backward
                if (newMoveState.forward !== moveState.forward) {
                    if (newMoveState.forward) {
                        simulateKeyEvent('ArrowUp', 'keydown');
                        currentKeys.add('ArrowUp');
                    } else {
                        simulateKeyEvent('ArrowUp', 'keyup');
                        currentKeys.delete('ArrowUp');
                    }
                }

                if (newMoveState.backward !== moveState.backward) {
                    if (newMoveState.backward) {
                        simulateKeyEvent('ArrowDown', 'keydown');
                        currentKeys.add('ArrowDown');
                    } else {
                        simulateKeyEvent('ArrowDown', 'keyup');
                        currentKeys.delete('ArrowDown');
                    }
                }

                // Handle left/right turning
                if (newMoveState.left !== moveState.left) {
                    if (newMoveState.left) {
                        simulateKeyEvent('ArrowLeft', 'keydown');
                        currentKeys.add('ArrowLeft');
                    } else {
                        simulateKeyEvent('ArrowLeft', 'keyup');
                        currentKeys.delete('ArrowLeft');
                    }
                }

                if (newMoveState.right !== moveState.right) {
                    if (newMoveState.right) {
                        simulateKeyEvent('ArrowRight', 'keydown');
                        currentKeys.add('ArrowRight');
                    } else {
                        simulateKeyEvent('ArrowRight', 'keyup');
                        currentKeys.delete('ArrowRight');
                    }
                }

                moveState = newMoveState;
            }

            function stopAllMovement() {
                currentKeys.forEach(key => {
                    simulateKeyEvent(key, 'keyup');
                });
                currentKeys.clear();
                moveState = { forward: false, backward: false, left: false, right: false };
            }

            // Virtual Joystick Implementation
            const joystick = document.getElementById('virtualJoystick');
            const knob = document.getElementById('joystickKnob');
            let joystickActive = false;
            let joystickCenter = { x: 0, y: 0 };
            let joystickRadius = 0;

            function initJoystick() {
                const rect = joystick.getBoundingClientRect();
                joystickCenter = {
                    x: rect.left + rect.width / 2,
                    y: rect.top + rect.height / 2
                };
                joystickRadius = rect.width / 2 - 20; // Account for knob size
            }

            function updateJoystick(touch) {
                if (!joystickActive) return;

                const dx = touch.clientX - joystickCenter.x;
                const dy = touch.clientY - joystickCenter.y;
                const distance = Math.min(Math.sqrt(dx * dx + dy * dy), joystickRadius);
                const angle = Math.atan2(dy, dx);

                const knobX = Math.cos(angle) * distance;
                const knobY = Math.sin(angle) * distance;

                knob.style.transform = `translate(calc(-50% + ${knobX}px), calc(-50% + ${knobY}px))`;

                // Normalize to -1 to 1 range
                const normalizedX = knobX / joystickRadius;
                const normalizedY = knobY / joystickRadius;

                updateMovement(normalizedX, normalizedY);
            }

            function resetJoystick() {
                knob.style.transform = 'translate(-50%, -50%)';
                joystickActive = false;
                stopAllMovement();
            }

            // Joystick event handlers
            joystick.addEventListener('touchstart', (e) => {
                e.preventDefault();
                joystickActive = true;
                initJoystick();
                updateJoystick(e.touches[0]);
            });

            document.addEventListener('touchmove', (e) => {
                if (joystickActive) {
                    e.preventDefault();
                    updateJoystick(e.touches[0]);
                }
            });

            document.addEventListener('touchend', (e) => {
                if (joystickActive) {
                    e.preventDefault();
                    resetJoystick();
                }
            });

            // Aim Area Implementation
            const aimArea = document.getElementById('aimArea');
            let aimActive = false;
            let lastAimPos = { x: 0, y: 0 };

            aimArea.addEventListener('touchstart', (e) => {
                e.preventDefault();
                aimActive = true;
                lastAimPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            });

            aimArea.addEventListener('touchmove', (e) => {
                if (!aimActive) return;
                e.preventDefault();

                const touch = e.touches[0];
                const deltaX = touch.clientX - lastAimPos.x;
                const deltaY = touch.clientY - lastAimPos.y;

                // Simulate mouse movement for aiming
                const sensitivity = 2;
                if (Math.abs(deltaX) > 2) {
                    const direction = deltaX > 0 ? 'ArrowRight' : 'ArrowLeft';
                    for (let i = 0; i < Math.abs(deltaX * sensitivity); i++) {
                        simulateKeyEvent(direction, 'keydown');
                        setTimeout(() => simulateKeyEvent(direction, 'keyup'), 10);
                    }
                }

                lastAimPos = { x: touch.clientX, y: touch.clientY };
            });

            aimArea.addEventListener('touchend', (e) => {
                e.preventDefault();
                aimActive = false;
            });

            // Button event handlers
            const touchButtons = document.querySelectorAll('.touch-button');
            touchButtons.forEach(button => {
                const keyCode = button.getAttribute('data-key');
                
                button.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    button.classList.add('active');
                    simulateKeyEvent(keyCode, 'keydown');
                });

                button.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    button.classList.remove('active');
                    simulateKeyEvent(keyCode, 'keyup');
                });

                button.addEventListener('touchcancel', (e) => {
                    e.preventDefault();
                    button.classList.remove('active');
                    simulateKeyEvent(keyCode, 'keyup');
                });

                button.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                });
            });
        }

        // Wait for dosbox to be ready
        window.addEventListener('load', function() {
            // Initialize mobile controls
            initMobileControls();
        });
    </script>
</body>

</html>
