<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JS DOOM üïπ</title>
    <link rel="stylesheet" type="text/css" href="./style.css">
    <link rel="stylesheet" type="text/css" href="./styles/button.css">
    <style>
        /* Mobile Touch Controls */
        .mobile-controls {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .mobile-controls.active {
            display: block;
        }

        .touch-button {
            position: absolute;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 8px;
            color: white;
            font-weight: bold;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            user-select: none;
            touch-action: manipulation;
        }

        .touch-button:active {
            background: rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 255, 255, 0.6);
        }

        /* D-Pad - Left Side */
        .dpad {
            bottom: 60px;
            left: 30px;
            width: 140px;
            height: 140px;
        }

        .dpad-up {
            top: 0;
            left: 50px;
            width: 40px;
            height: 40px;
        }

        .dpad-down {
            bottom: 0;
            left: 50px;
            width: 40px;
            height: 40px;
        }

        .dpad-left {
            left: 0;
            top: 50px;
            width: 40px;
            height: 40px;
        }

        .dpad-right {
            right: 0;
            top: 50px;
            width: 40px;
            height: 40px;
        }

        /* Action Buttons - Right Side */
        .action-buttons {
            bottom: 60px;
            right: 30px;
            width: 140px;
            height: 140px;
        }

        .btn-fire {
            bottom: 50px;
            right: 0;
            width: 60px;
            height: 60px;
            background: rgba(255, 0, 0, 0.3);
            border-color: rgba(255, 0, 0, 0.5);
            font-size: 14px;
        }

        .btn-fire:active {
            background: rgba(255, 0, 0, 0.5);
        }

        .btn-action {
            bottom: 50px;
            right: 80px;
            width: 60px;
            height: 60px;
            background: rgba(0, 255, 0, 0.3);
            border-color: rgba(0, 255, 0, 0.5);
            font-size: 12px;
        }

        .btn-action:active {
            background: rgba(0, 255, 0, 0.5);
        }

        .btn-start {
            bottom: 0;
            right: 40px;
            width: 60px;
            height: 40px;
            background: rgba(255, 255, 0, 0.3);
            border-color: rgba(255, 255, 0, 0.5);
            font-size: 12px;
        }

        .btn-start:active {
            background: rgba(255, 255, 0, 0.5);
        }

        @media (max-width: 768px) {
            .dosbox-container {
                width: 100vw;
                height: 60vh;
                margin: 5% auto 0 auto;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="dosbox"></div>
        <button class="wrapper" onclick="enterFullscreen();">
            <a><span>FULLSCREEN</span></a>
        </button>
    </div>

    <!-- Mobile Touch Controls -->
    <div class="mobile-controls" id="mobileControls">
        <!-- D-Pad - Left Side -->
        <div class="dpad">
            <div class="touch-button dpad-up" data-key="ArrowUp">‚Üë</div>
            <div class="touch-button dpad-down" data-key="ArrowDown">‚Üì</div>
            <div class="touch-button dpad-left" data-key="ArrowLeft">‚Üê</div>
            <div class="touch-button dpad-right" data-key="ArrowRight">‚Üí</div>
        </div>

        <!-- Action Buttons - Right Side -->
        <div class="action-buttons">
            <div class="touch-button btn-action" data-key=" ">ACTION</div>
            <div class="touch-button btn-fire" data-key="Control">FIRE</div>
            <div class="touch-button btn-start" data-key="Enter">START</div>
        </div>
    </div>

    <script type="text/javascript" src="./script.js"></script>
    <script type="text/javascript">
        var dosbox = new Dosbox({
            id: "dosbox",
            onload: function (dosbox) {
                dosbox.run("/jsdoom/roms/ultimate-doom.zip", "./UltDoom/DOOM.EXE");
            },
            onrun: function (dosbox, app) {
                console.log("App '" + app + "' is runned");
            }
        });

        // Mobile Detection and Touch Controls
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                   (window.innerWidth <= 768 && 'ontouchstart' in window);
        }

        function isFullscreen() {
            return !!(document.fullscreenElement || document.webkitFullscreenElement || 
                     document.mozFullScreenElement || document.msFullscreenElement);
        }

        function enterFullscreen() {
            const element = document.documentElement;
            if (element.requestFullscreen) {
                element.requestFullscreen();
            } else if (element.webkitRequestFullscreen) {
                element.webkitRequestFullscreen();
            } else if (element.mozRequestFullScreen) {
                element.mozRequestFullScreen();
            } else if (element.msRequestFullscreen) {
                element.msRequestFullscreen();
            }
        }

        function updateMobileControls() {
            const mobileControls = document.getElementById('mobileControls');
            if (isMobileDevice() && isFullscreen()) {
                mobileControls.classList.add('active');
                console.log('Mobile fullscreen detected, showing touch controls');
            } else {
                mobileControls.classList.remove('active');
            }
        }

        function initMobileControls() {
            if (!isMobileDevice()) return;

            // Listen for fullscreen changes
            document.addEventListener('fullscreenchange', updateMobileControls);
            document.addEventListener('webkitfullscreenchange', updateMobileControls);
            document.addEventListener('mozfullscreenchange', updateMobileControls);
            document.addEventListener('MSFullscreenChange', updateMobileControls);

            // Get the canvas element for key events
            let canvas = null;
            const findCanvas = () => {
                canvas = document.querySelector('.dosbox-canvas');
                if (!canvas) {
                    setTimeout(findCanvas, 100);
                }
            };
            findCanvas();

            // Function to simulate key events
            function simulateKeyEvent(keyCode, type) {
                if (!canvas) return;
                
                let eventKeyCode = 0;
                switch(keyCode) {
                    case 'ArrowUp': eventKeyCode = 38; break;
                    case 'ArrowDown': eventKeyCode = 40; break;
                    case 'ArrowLeft': eventKeyCode = 37; break;
                    case 'ArrowRight': eventKeyCode = 39; break;
                    case ' ': eventKeyCode = 32; break;
                    case 'Control': eventKeyCode = 17; break;
                    case 'Enter': eventKeyCode = 13; break;
                }
                
                const event = new KeyboardEvent(type, {
                    key: keyCode,
                    code: keyCode,
                    keyCode: eventKeyCode,
                    bubbles: true,
                    cancelable: true
                });
                
                canvas.dispatchEvent(event);
                document.dispatchEvent(event);
            }

            // Add touch event listeners to all touch buttons
            const touchButtons = document.querySelectorAll('.touch-button');
            touchButtons.forEach(button => {
                const keyCode = button.getAttribute('data-key');
                
                // Handle touch start
                button.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    button.classList.add('active');
                    simulateKeyEvent(keyCode, 'keydown');
                });

                // Handle touch end
                button.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    button.classList.remove('active');
                    simulateKeyEvent(keyCode, 'keyup');
                });

                // Handle touch cancel
                button.addEventListener('touchcancel', (e) => {
                    e.preventDefault();
                    button.classList.remove('active');
                    simulateKeyEvent(keyCode, 'keyup');
                });

                // Prevent context menu
                button.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                });
            });
        }

        // Automatically click the dosbox-start button after first user interaction
        var hasUserInteracted = false;
        var dosboxReady = false;
        
        function tryAutoStart() {
            if (hasUserInteracted && dosboxReady) {
                var startButton = document.querySelector('.dosbox-start');
                if (startButton) {
                    startButton.click();
                    console.log("Auto-clicked dosbox-start button with audio support");
                } else {
                    console.log("dosbox-start button not found");
                }
            }
        }
        
        // Wait for first user interaction (click, touch, or key press)
        function enableAutoStart() {
            hasUserInteracted = true;
            console.log("User interaction detected, enabling auto-start");
            tryAutoStart();
            // Remove the event listeners since we only need one interaction
            document.removeEventListener('click', enableAutoStart);
            document.removeEventListener('touchstart', enableAutoStart);
            document.removeEventListener('keydown', enableAutoStart);
        }
        
        document.addEventListener('click', enableAutoStart);
        document.addEventListener('touchstart', enableAutoStart);
        document.addEventListener('keydown', enableAutoStart);
        
        // Wait for dosbox to be ready
        window.addEventListener('load', function() {
            // Initialize mobile controls
            initMobileControls();
            
            setTimeout(function() {
                dosboxReady = true;
                console.log("Dosbox ready, waiting for user interaction");
                tryAutoStart();
            }, 500);
        });
    </script>
</body>

</html>
